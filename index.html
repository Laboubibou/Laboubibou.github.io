<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Riders Republic - Classements</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0d0f10;
      --surface: #15181b;
      --surface-2: #1a1f23;
      --text: #e8ecef;
      --muted: #a7b0b7;
      --brand: #f1ff00;
      --accent: #21c9b6;
      --danger: #ff5a5f;
      --gold: #f6c90e;
      --silver: #c0c7d1;
      --bronze: #cd7f32;
      --radius: 14px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: 'Montserrat', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.35;
      background-image: radial-gradient(1000px 400px at -10% -20%, rgba(33,201,182,.10), transparent),
                        radial-gradient(800px 300px at 120% 10%, rgba(241,255,0,.06), transparent);
    }
    a { color: inherit; text-decoration: none; }

    .header {
      position: sticky; top: 0; z-index: 50; backdrop-filter: blur(8px);
      background: linear-gradient(180deg, rgba(13,15,16,.85), rgba(13,15,16,.55));
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .container { width: min(1200px, 94%); margin: 0 auto; }
    .nav { display: flex; align-items: center; justify-content: space-between; padding: 14px 0; }
    .brand {
      display: flex; align-items: center; gap: 12px; font-weight: 800; letter-spacing: .3px;
    }
    .brand-badge { width: 36px; height: 36px; border-radius: 10px; background: var(--brand); color: #111; display: grid; place-items: center; font-weight: 900; box-shadow: var(--shadow); object-fit: cover; }
    .nav-cta { display: flex; gap: 10px; align-items: center; }
    .btn {
      display: inline-flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,.08);
      background: var(--surface); color: var(--text); cursor: pointer; transition: .2s ease; font-weight: 600;
    }
    .btn:hover { transform: translateY(-1px); background: var(--surface-2); }
    .btn--brand { background: var(--brand); color: #0d0f10; border-color: rgba(0,0,0,.1); }
    .btn--brand:hover { filter: brightness(.98); }

    .hero { padding: 24px 0 6px; }
    .title { font-family: 'Bebas Neue', sans-serif; letter-spacing: .5px; font-size: clamp(30px, 5vw, 52px); line-height: 1; margin: 2px 0 14px; }
    .subtitle { color: var(--muted); margin-bottom: 22px; }

    .filters {
      display: flex;
      flex-direction: column;
      gap: 16px;
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
    }
    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .chip {
      padding: 8px 16px;
      border-radius: 999px;
      background: var(--surface);
      border: 1px solid rgba(255,255,255,.08);
      color: var(--text);
      cursor: pointer;
    }
    .chip.is-active {
      background: var(--brand);
      color: #111;
    }
    .select-group {
      width: 100%;
    }
    .select {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      background: var(--surface);
      border: 1px solid rgba(255,255,255,.08);
      color: var(--text);
      cursor: pointer;
    }
    .mode-group {
      display: flex;
      justify-content: center;
      margin-top: 8px;
    }
    .tabs.compact {
      display: inline-flex;
      background: var(--surface);
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,.08);
    }
    .tab {
      padding: 8px 16px;
      background: transparent;
      border: none;
      color: var(--text);
      cursor: pointer;
      min-width: 80px;
    }
    .tab.is-active {
      background: var(--brand);
      color: #111;
    }

    .field { grid-column: span 6; display: flex; flex-direction: column; gap: 8px; }
    .field label { font-size: 13px; color: var(--muted); }
    .select, .input { width: 100%; padding: 12px 14px; border-radius: 12px; background: var(--surface); color: var(--text); border: 1px solid rgba(255,255,255,.08); outline: none; }

    .tabs {
      margin: 16px 0;
      transition: opacity 0.3s ease;
    }

    .tabs[style*="opacity: 0.5"] {
      cursor: not-allowed;
    }

    #eventSelect {
      transition: opacity 0.3s ease;
    }

    #eventSelect[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .tabs {
      display: inline-flex;
      background: var(--surface);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 8px;
      overflow: hidden;
      width: auto; /* Au lieu de 100% */
      margin: 20px 0;
    }
    .tab {
      padding: 8px 16px; /* Réduit le padding */
      cursor: pointer;
      font-weight: 600;
      font-size: 14px; /* Texte légèrement plus petit */
      color: var(--text);
      border: none;
      background: transparent;
      min-width: 80px; /* Largeur minimum */
    }
    .tab.is-active {
      background: var(--brand);
      color: #111;
    }

    .event-select-wrapper {
      margin-top: 20px;
      width: 100%;
    }

    .select {
      width: 100%;
      padding: 12px;
      background: var(--surface);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 8px;
      color: var(--text);
      cursor: pointer;
      appearance: none; /* Personnalise la flèche du select */
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23ffffff' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 32px;
    }

    .select:focus {
      outline: none;
      border-color: var(--brand);
    }

    .podium { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; margin: 20px 0; }
    .podium-card {
      grid-column: span 4; background: linear-gradient(180deg, var(--surface-2), var(--surface)); border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow);
    }
    .medal { width: 28px; height: 28px; border-radius: 8px; display: grid; place-items: center; font-weight: 900; color: #111; }
    .medal.gold { background: var(--gold); }
    .medal.silver { background: var(--silver); }
    .medal.bronze { background: var(--bronze); }
    .player { display: flex; align-items: center; gap: 12px; margin-top: 10px; }
    .avatar { width: 42px; height: 42px; border-radius: 12px; background: #222; display: grid; place-items: center; font-weight: 800; }
    .score { font-size: 22px; font-weight: 800; margin-top: 6px; }
    .meta { font-size: 12px; color: var(--muted); }

    .card { background: linear-gradient(180deg, var(--surface), rgba(26,31,35,.8)); border: 1px solid rgba(255,255,255,.08); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; }
    .table-head { display: grid; grid-template-columns: 60px 1.3fr 0.8fr 1fr 0.8fr 0.8fr 0.8fr; gap: 12px; padding: 14px 16px; background: rgba(255,255,255,.03); border-bottom: 1px solid rgba(255,255,255,.06); position: sticky; top: 64px; z-index: 5; }
    .th { color: var(--muted); font-size: 13px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 6px; }
    .rows { max-height: 560px; overflow: auto; }
    .row { display: grid; grid-template-columns: 60px 1.3fr 0.8fr 1fr 0.8fr 0.8fr 0.8fr; gap: 12px; padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,.06); }
    .row:hover { background: rgba(255,255,255,.03); }
    .rank { font-weight: 900; color: var(--muted); }
    .tag { padding: 4px 8px; border-radius: 999px; font-size: 12px; font-weight: 800; background: rgba(255,255,255,.06); }

    .toolbar { display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; gap: 12px; }
    .search { flex: 1; display: flex; gap: 8px; }
    .search input { flex: 1; }

    @media (max-width: 900px) {
      .table-head, .row { grid-template-columns: 50px 1.2fr 1fr 1fr 0.8fr 0.8fr; }
      .hide-md { display: none; }
      .podium-card { grid-column: span 12; }
      .field { grid-column: span 12; }
    }
    @media (max-width: 540px) {
      .nav { padding: 10px 0; }
      .title { font-size: 34px; }
      .toolbar { flex-direction: column; align-items: stretch; }
    }

    #adminModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    #adminModal .modal-content {
      background: #15181b;
      color: #e8ecef;
      padding: 32px 24px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
      width: 90%;
      max-width: 400px;
      position: relative;
    }

    #adminModal h2 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2rem;
      margin-bottom: 18px;
    }

    #adminModal label {
      display: block;
      margin-bottom: 8px;
    }

    #adminModal input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #222;
      background: #222;
      color: #fff;
      margin-bottom: 16px;
    }

    #adminModal button[type="submit"] {
      width: 100%;
      padding: 12px 0;
      border-radius: 8px;
      background: #f1ff00;
      color: #111;
      font-weight: 700;
      font-size: 1rem;
      border: none;
      cursor: pointer;
    }

    #closeAdmin {
      position: absolute;
      top: 12px;
      right: 16px;
      background: none;
      border: none;
      color: #fff;
      font-size: 22px;
      cursor: pointer;
    }

    #submitModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    #submitModal .modal-content {
      background: #15181b;
      color: #e8ecef;
      padding: 32px 24px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
      width: 90%;
      max-width: 420px;
      position: relative;
    }

    #submitModal h2 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2rem;
      margin-bottom: 18px;
    }

    #submitModal label {
      display: block;
      margin-bottom: 8px;
    }

    #submitModal input,
    #submitModal select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #222;
      background: #222;
      color: #fff;
      margin-bottom: 16px;
    }

    #submitModal button[type="submit"] {
      width: 100%;
      padding: 12px 0;
      border-radius: 8px;
      background: #f1ff00;
      color: #111;
      font-weight: 700;
      font-size: 1rem;
      border: none;
      cursor: pointer;
    }

    #closeSubmit {
      position: absolute;
      top: 12px;
      right: 16px;
      background: none;
      border: none;
      color: #fff;
      font-size: 22px;
      cursor: pointer;
    }

    .tab[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* --- Nouveaux styles pour la disposition des filtres --- */
    .filter-columns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 16px;
    }

    .filter-column {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin: 0;
    }

    .tab {
      flex: 1;
      padding: 10px;
      border: 1px solid rgba(255,255,255,.08);
      background: var(--surface);
      color: var(--text);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .tab.is-active {
      background: var(--brand);
      color: #111;
      border-color: transparent;
    }

    @media (max-width: 640px) {
      .filter-columns {
        grid-template-columns: 1fr;
        gap: 12px;
      }
    }

    .modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}

.modal-content {
  background: var(--surface);
  padding: 24px;
  border-radius: 12px;
  width: 90%;
  max-width: 480px;
  position: relative;
}

.time-fields {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
}

.time-fields input {
  text-align: center;
  padding: 8px;
}

.close-btn {
  position: absolute;
  right: 16px;
  top: 16px;
  background: none;
  border: none;
  color: var(--text);
  font-size: 24px;
  cursor: pointer;
}

    .user-menu {
        position: absolute;
        top: 16px;
        right: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .user-avatar:hover {
        transform: scale(1.1);
    }

    .logout-btn {
        display: none;
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 8px;
        padding: 8px 16px;
        background: var(--surface);
        border: 1px solid rgba(255,255,255,.1);
        border-radius: 8px;
        color: var(--text);
        cursor: pointer;
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="container nav">
      <div class="brand">
        <img src="logo.png" alt="Riders Republic Logo" style="width:36px;height:36px;border-radius:10px;object-fit:cover;box-shadow:0 10px 30px rgba(0,0,0,.35);" />
        <div>
          <div style="font-weight:900;">Riders Republic</div>
          <div style="font-size:12px;color:var(--muted);margin-top:-2px;">Classements communautaires</div>
        </div>
      </div>
      <div class="nav-cta">
        <a class="btn" href="/auth">Se connecter</a>
        <a class="btn btn--brand" href="submit.html" id="addRunBtn">+ Soumettre une run</a>
      </div>
    </div>

    <div class="user-menu" id="userMenu">
        <img src="user.png" alt="Avatar" class="user-avatar" id="userAvatar">
        <button id="logoutBtn" class="logout-btn">Déconnexion</button>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <h1 class="title">Classements officieux Points & Chronos</h1>
      <div class="subtitle">Filtre par discipline, épreuve, plateforme ou recherche de joueur.</div>

      <div class="filters">
        <!-- Disciplines en haut -->
        <div class="chip-group" id="disciplineChips">
          <button class="chip is-active" data-value="all">Tous</button>
          <button class="chip" data-value="bike">Vélo</button>
          <button class="chip" data-value="snow">Snow</button>
          <button class="chip" data-value="air">Air</button>
        </div>

        <!-- Liste déroulante des épreuves -->
        <div class="select-group">
          <select class="select" id="eventSelect">
            <option value="all">Toutes les épreuves</option>
          </select>
        </div>

        <!-- Points/Chronos en bas -->
        <div class="mode-group">
          <div class="tabs compact" id="modeTabs">
            <button class="tab is-active" data-mode="points">Points</button>
            <button class="tab" data-mode="time">Chronos</button>
          </div>
        </div>
      </div>
    </section>

    <section class="podium" id="podium">
      <!-- Top 3 injected here -->
    </section>

    <section class="card">
      <div class="toolbar">
        <div class="search">
          <input class="input" id="searchInput" placeholder="Rechercher un joueur ou une épreuve..." />
          <button class="btn" id="clearSearch">Effacer</button>
        </div>
        <div style="display:flex; gap:8px;">
          <button class="btn" id="exportCsv">Exporter CSV</button>
          <button class="btn" id="resetFilters">Réinitialiser</button>
        </div>
      </div>

      <div class="table-head">
        <div class="th" data-sort="rank">#</div>
        <div class="th" data-sort="player">Joueur</div>
        <div class="th" data-sort="platform">Plateforme</div>
        <div class="th" data-sort="event">Épreuve</div>
        <div class="th" data-sort="score" id="th-score">Score</div>
        <div class="th" data-sort="timeMs" id="th-time">Temps</div>
        <div class="th hide-md" data-sort="date">Date</div>
      </div>
      <div class="rows" id="rows"></div>
    </section>
  </main>

  <div id="adminModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.6);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:#15181b;color:#e8ecef;padding:32px 24px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);width:90%;max-width:400px;position:relative;">
      <button id="closeAdmin" style="position:absolute;top:12px;right:16px;background:none;border:none;color:#fff;font-size:22px;cursor:pointer;">&times;</button>
      <h2 style="font-family:'Bebas Neue',sans-serif;font-size:2rem;margin-bottom:18px;">Connexion Admin</h2>
      <form>
        <label style="display:block;margin-bottom:8px;">Identifiant</label>
        <input type="text" style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid #222;background:#222;color:#fff;margin-bottom:16px;" placeholder="Nom d'utilisateur" />
        <label style="display:block;margin-bottom:8px;">Mot de passe</label>
        <input type="password" style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid #222;background:#222;color:#fff;margin-bottom:24px;" placeholder="Mot de passe" />
        <button type="submit" style="width:100%;padding:12px 0;border-radius:8px;background:#f1ff00;color:#111;font-weight:700;font-size:1rem;border:none;cursor:pointer;">Se connecter</button>
      </form>
    </div>
  </div>

  <div id="submitModal" class="modal">
  <div class="modal-content">
    <button id="closeSubmit" class="close-btn">&times;</button>
    <h2>Soumettre une run</h2>
    <form id="submitForm">
      <div class="form-group">
        <label>Discipline</label>
        <select name="discipline" required>
          <option value="">Choisir une discipline</option>
          <option value="bike">Vélo</option>
          <option value="snow">Snow</option>
          <option value="air">Air</option>
        </select>
      </div>

      <div class="form-group">
        <label>Type</label>
        <select name="type" id="runType" required>
          <option value="points">Points</option>
          <option value="time">Chronos</option>
        </select>
      </div>

      <div class="form-group">
        <label>Épreuve</label>
        <select name="event" id="runEvent" required>
          <option value="">Choisir d'abord une discipline</option>
        </select>
      </div>

      <div id="scoreInput" class="form-group">
        <label>Score</label>
        <input type="number" name="score" min="0">
      </div>

      <div id="timeInput" class="form-group" style="display:none;">
        <label>Temps</label>
        <div class="time-fields">
          <input type="number" name="hours" min="0" max="23" placeholder="H">
          <input type="number" name="minutes" min="0" max="59" placeholder="M">
          <input type="number" name="seconds" min="0" max="59" placeholder="S">
          <input type="number" name="milliseconds" min="0" max="999" placeholder="MS">
        </div>
      </div>

      <button type="submit">Envoyer</button>
    </form>
  </div>
</div>

  <script>
    // --- Import automatique depuis Google Sheets ---
    let sample = [];

    fetch("https://api.sheetbest.com/sheets/c4d0a049-562b-4a08-9b1c-60631fcff8cf")
      .then(res => res.json())
      .then(data => {
        sample = data.map((r, i) => ({
          rank: Number(r.rank) || i + 1,
          player: r.participant || r.player || "",
          platform: r.platform || "",
          event: r.event || "",
          discipline: r.category || r.discipline || "",
          mode: r.type === "score" ? "points" : "time",
          score: r.value && r.type === "score" ? Number(r.value) : null,
          timeMs: r.value && r.type === "time" ? Number(r.value) : null,
          date: r.date || "",
        }));
        update();
      });

    // État initial
const state = {
  discipline: 'all',
  mode: 'points',
  event: 'all'
};

    const rowsEl = document.getElementById('rows');
    const podiumEl = document.getElementById('podium');

    function formatNumber(n) { return n ? n.toLocaleString('fr-FR') : '-'; }
    function formatTime(ms) {
      if (!ms) return '-';
      const totalSeconds = Math.floor(ms / 1000);
      const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
      const seconds = (totalSeconds % 60).toString().padStart(2, '0');
      const hundreds = Math.floor((ms % 1000) / 10).toString().padStart(2, '0');
      return `${minutes}:${seconds}.${hundreds}`;
    }

    function applyFilters(data) {
      return data.filter(r =>
        r.mode === state.mode
        && (state.discipline === 'all' || r.discipline === state.discipline)
        && (state.event === 'all' || r.event === state.event)
        && (state.platform === 'all' || r.platform === state.platform)
        && (!state.search || `${r.player} ${r.event}`.toLowerCase().includes(state.search.toLowerCase()))
      );
    }

    function sortData(data) {
      const { key, dir } = state.sort;
      const mul = dir === 'asc' ? 1 : -1;
      return [...data].sort((a, b) => {
        const va = a[key] ?? 0;
        const vb = b[key] ?? 0;
        if (va < vb) return -1 * mul;
        if (va > vb) return 1 * mul;
        return 0;
      });
    }

    function renderPodium(data) {
      const top3 = sortData(data).slice(0, 3);
      podiumEl.innerHTML = top3.map((r, i) => `
        <div class="podium-card">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div class="medal ${i===0?'gold':i===1?'silver':'bronze'}">${i+1}</div>
            <div class="tag">${r.event}</div>
          </div>
          <div class="player">
            <div class="avatar">${r.player.slice(0,2).toUpperCase()}</div>
            <div>
              <div style="font-weight:800;">${r.player}</div>
              <div class="meta">${r.platform} • ${r.discipline}</div>
            </div>
          </div>
          <div class="score">${state.mode==='points' ? formatNumber(r.score) + ' pts' : formatTime(r.timeMs)}</div>
          <div class="meta">${r.date ? new Date(r.date).toLocaleDateString('fr-FR') : ''}</div>
        </div>
      `).join('');
    }

    function renderRows(data) {
      rowsEl.innerHTML = data.map(r => `
        <div class="row">
          <div class="rank">${r.rank}</div>
          <div style="display:flex;align-items:center;gap:10px;">
            <div class="avatar" style="width:32px;height:32px;border-radius:10px;">${r.player.slice(0,2).toUpperCase()}</div>
            <div>
              <div style="font-weight:700;">${r.player}</div>
              <div class="meta hide-md">${r.discipline}</div>
            </div>
          </div>
          <div>${r.platform}</div>
          <div>${r.event}</div>
          <div>${state.mode==='points' ? formatNumber(r.score) : '-'}</div>
          <div>${state.mode==='time' ? formatTime(r.timeMs) : '-'}</div>
          <div class="hide-md">${r.date ? new Date(r.date).toLocaleDateString('fr-FR') : ''}</div>
        </div>
      `).join('');
    }

    function update() {
      const filtered = applyFilters(sample);
      const sorted = sortData(filtered);
      renderPodium(sorted);
      renderRows(sorted);
      document.getElementById('th-score').style.opacity = state.mode==='points' ? '1' : '.4';
      document.getElementById('th-time').style.opacity = state.mode==='time' ? '1' : '.4';
    }

    // Interactions
    document.getElementById('disciplineChips').addEventListener('click', e => {
  if (!e.target.classList.contains('chip')) return;

  document.querySelectorAll('#disciplineChips .chip').forEach(c => c.classList.remove('is-active'));
  e.target.classList.add('is-active');

  state.discipline = e.target.dataset.value;
  state.event = 'all';

  // Active/désactive les tabs Points/Chronos
  const modeTabs = document.getElementById('modeTabs');
  if (state.discipline === 'all') {
    modeTabs.style.opacity = '0.5';
    modeTabs.style.pointerEvents = 'none';
    document.getElementById('eventSelect').innerHTML = '<option value="all">Choisir d\'abord une discipline</option>';
  } else {
    modeTabs.style.opacity = '1';
    modeTabs.style.pointerEvents = 'auto';
    updateEventsList(state.discipline, state.mode);
  }

  update();
});

    // Gestion des tabs Points/Chronos
    document.getElementById('modeTabs').addEventListener('click', e => {
  if (!e.target.classList.contains('tab')) return;

  document.querySelectorAll('#modeTabs .tab').forEach(t => t.classList.remove('is-active'));
  e.target.classList.add('is-active');

  state.mode = e.target.dataset.mode;
  state.event = 'all';

  if (state.discipline !== 'all') {
    updateEventsList(state.discipline, state.mode);
  }

  update();
});

    // Mise à jour de la liste des épreuves
    function updateEventsList(discipline, mode) {
  const eventSelect = document.getElementById('eventSelect');
  eventSelect.innerHTML = '<option value="all">Choisir une épreuve</option>';

  if (discipline !== 'all' && eventsByDiscipline[discipline]) {
    const events = eventsByDiscipline[discipline][mode] || [];
    events.forEach(ev => {
      const option = document.createElement('option');
      option.value = ev;
      option.textContent = ev;
      eventSelect.appendChild(option);
    });
  }
}

    document.getElementById('searchInput').addEventListener('input', e => { state.search = e.target.value; update(); });
    document.getElementById('clearSearch').addEventListener('click', () => { document.getElementById('searchInput').value=''; state.search=''; update(); });
    document.getElementById('resetFilters').addEventListener('click', () => {
      state.discipline='all'; state.event='all'; state.platform='all'; state.search='';
      document.getElementById('searchInput').value='';
      document.querySelectorAll('#disciplineChips .chip').forEach((c,i)=>c.classList.toggle('is-active', i===0));
      document.getElementById('eventSelect').value='all';
      document.getElementById('platformSelect').value='all';
      update();
    });

    document.querySelectorAll('.th').forEach(th => th.addEventListener('click', () => {
      const key = th.dataset.sort;
      if (!key) return;
      if (state.sort.key === key) {
        state.sort.dir = state.sort.dir === 'asc' ? 'desc' : 'asc';
      } else {
        state.sort.key = key; state.sort.dir = 'asc';
      }
      update();
    }));

    document.getElementById('exportCsv').addEventListener('click', () => {
      const rows = sortData(applyFilters(sample));
      const headers = ['rank','player','platform','event','discipline','mode','score','timeMs','date'];
      const csv = [headers.join(',')].concat(rows.map(r => headers.map(h => r[h] ?? '').join(','))).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='classement_rr.csv'; a.click(); URL.revokeObjectURL(url);
    });

    document.querySelector('.nav-cta .btn').addEventListener('click', function(e) {
      if (this.textContent.includes('Admin')) {
        e.preventDefault();
        document.getElementById('adminModal').style.display = 'flex';
      }
    });
    document.getElementById('closeAdmin').onclick = () => {
      document.getElementById('adminModal').style.display = 'none';
    };
    document.querySelector('#adminModal form').onsubmit = e => {
      e.preventDefault();
      // Ajoute ici la logique d'authentification si besoin
      alert('Connexion admin simulée !');
      document.getElementById('adminModal').style.display = 'none';
    };

    // Ouvre la modale "Soumettre une run"
    document.getElementById('addRunBtn').onclick = function(e) {
      e.preventDefault();
      document.getElementById('submitModal').style.display = 'flex';
    };
    // Ferme la modale
    document.getElementById('closeSubmit').onclick = function() {
      document.getElementById('submitModal').style.display = 'none';
    };
    // Gestion du type de run (points/chronos)
    document.getElementById('runType').onchange = function() {
  const isTime = this.value === 'time';
  document.getElementById('scoreInput').style.display = isTime ? 'none' : 'block';
  document.getElementById('timeInput').style.display = isTime ? 'block' : 'none';
};

// Mise à jour des épreuves dans le formulaire
document.querySelector('#submitForm select[name="discipline"]').onchange = function() {
  const discipline = this.value;
  const type = document.getElementById('runType').value;
  const eventSelect = document.getElementById('runEvent');
  
  eventSelect.innerHTML = '<option value="">Choisir une épreuve</option>';
  
  if (discipline && eventsByDiscipline[discipline]) {
    const events = eventsByDiscipline[discipline][type === 'points' ? 'points' : 'time'] || [];
    events.forEach(event => {
      const option = document.createElement('option');
      option.value = event;
      option.textContent = event;
      eventSelect.appendChild(option);
    });
  }
};

// Gestion du formulaire de soumission
document.getElementById('submitForm').onsubmit = function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const data = {
    discipline: formData.get('discipline'),
    type: formData.get('type'),
    event: formData.get('event'),
    value: formData.get('type') === 'points' ? 
      formData.get('score') : 
      ((parseInt(formData.get('hours')) * 3600000) + 
       (parseInt(formData.get('minutes')) * 60000) + 
       (parseInt(formData.get('seconds')) * 1000) + 
       parseInt(formData.get('milliseconds')))
  };

  // TODO: Envoyer vers ton API/Sheet.best
  console.log('Données à envoyer:', data);
  
  alert('Run soumise avec succès !');
  this.reset();
  document.getElementById('submitModal').style.display = 'none';
};


    state.sort = { key: 'score', dir: 'desc' };
    // update(); // plus besoin, sera appelé après fetch

    // Dans la partie <script>, ajoute cette constante avec toutes les courses :
    const eventsByDiscipline = {
  bike: {
    points: [
      "The Crown", "The Patriarch", "Family Feud", "Santa Cruz Gravity Fest",
      "Once Upon a Line", "Infinite Waves", "Around The World", "B-Side",
      "Trout's Trail", "Captain Cap", "Red Bull Joyride", "50/50",
      "Splintered", "King Monkey", "The Flow", "Red Bull District Ride",
      "Colorado Rush", "The Circus", "Bangers and Crash", "Canyon Dual Style",
      "The Freezer", "Red Bull Rampage", "Red Bull Rampage 2017"
    ],
    time: [
      "Welcome to Riders", "The Giants", "Red Bull Holy Bike", "Urban Freestyle",
      "Diving Board", "Skrrt Skrrt", "Ridge TV Luckt Straight", "Santa Cruz Urban Ride",
      "Don't Look Down", "Frontier", "Sentinel Path", "A Nice Day Out…",
      "The Fissure Loop", "Liberty Cap Ride", "Red Bull Road Rage", "Watchman Trail",
      "Burnt Rubber", "Understeer", "Hoola Loop", "Hospital Trail",
      "V-Loop", "The Swell", "Red Bull Hardline", "Lost in Sequoia",
      "Floor by Floor", "Xing", "Arrow Run", "Fox Racing Mtn. Rush",
      "Ford Foot Out"
    ]
  },
  snow: {
    points: [
      "Mammoth Can Jump", "Taco'd", "King Size", "Red Bull Ultra Natural",
      "The Bowl", "Wolfpack", "The Trunk", "Eagles Are Flying",
      "Snake Run", "Burton Grove", "Down of Teton", "Bliss",
      "Dude, Yu OK?", "The Tusks", "Ice Rider", "Blind Test",
      "Red Bull Linecatcher", "Log Rider", "Crest in Peace", "Paint Scratch",
      "Left Side", "Hold My Bear", "Ridge TV Option 7", "Trees Don't Move",
      "Tricks Derby", "Sideways", "The Village", "Red Bull Play Streets",
      "Snow Whisperer", "Timber", "Invasion", "X-Games",
      "Spine In The Dark", "Rossignol Man Vs Wild", "Red Bull Park Sessions", "Salomon Masterclass"
    ],
    time: [
      "Dreamline", "Spring Diet", "Pathfinder", "Red Bull Homerun",
      "Hold Your Breath", "Backbone", "Ice Edge", "8 Ball",
      "Ridge TV Multiball", "Killing Moon", "Dirty Hairy", "Bears On The Heels",
      "Ridge TV Snow Rush", "In Between The Line", "Trees To One Go!", "Rossignol Feel The Powder",
      "Back On Track", "For Real", "Elbow To Elbow", "Salomon All In One"
    ]
  },
  air: {
    points: [
      "More'o Rocky", "Marble Fly", "Look At The Whole", "Narrow Canyon",
      "Ridge TV Wall of Windows", "Break Point", "Frozen Wings", "Hoodoo You Do ?",
      "Half Dome Kisses", "Fog This!", "Ridge TV Night Wing", "Thermal Shock",
      "Underline", "Canyon Flight", "Last Subway", "Ford The Dive"
    ],
    time: [
      "Ridge TV The Dragonfly", "King Run", "In Between The Domes", "Hot Wings",
      "Migration", "Stream Rocket", "Rocket Congress", "Ridge TV Angels Flight",
      "8 Shape", "Dine and Dash", "Rocky Road", "Night Bird",
      "Canyon Loop", "Broken Wing", "Sunburn", "The Crest",
      "0 Faults", "Red Bull Aces"
    ]
  }
};

    // Remplace la partie des chips par :
    document.getElementById('disciplineChips').innerHTML = `
      <button class="chip is-active" data-value="all">Tous</button>
      <button class="chip" data-value="bike">Vélo</button>
      <button class="chip" data-value="snow">Snow</button>
      <button class="chip" data-value="air">Air</button>
    `;

    // Ajoute les événements aux nouvelles chips
    document.querySelectorAll('#disciplineChips .chip').forEach(c => {
      c.addEventListener('click', (e) => {
        document.querySelectorAll('#disciplineChips .chip').forEach(c => c.classList.remove('is-active'));
        e.target.classList.add('is-active');
        state.discipline = e.target.dataset.value;
        // Remplit le sélecteur d'épreuves en fonction de la discipline
        const events = eventsByDiscipline[state.discipline] || [];
        const eventSelect = document.getElementById('eventSelect');
        eventSelect.innerHTML = `<option value="all">Toutes</option>` + events.map(ev => `<option>${ev}</option>`).join('');
        state.event = 'all'; // Réinitialise l'épreuve
        update();
      });
    });

    // Ajoute ce code dans la partie <script> pour gérer la sélection des courses :
    document.getElementById('disciplineChips').addEventListener('click', function(e) {
        if (!e.target.classList.contains('chip')) return;
        
        // Met à jour les chips actifs
        document.querySelectorAll('#disciplineChips .chip').forEach(c => c.classList.remove('is-active'));
        e.target.classList.add('is-active');
        
        // Récupère la discipline sélectionnée
        const discipline = e.target.dataset.value;
        state.discipline = discipline;
        
        // Met à jour la liste des épreuves
        const eventSelect = document.getElementById('eventSelect');
        eventSelect.innerHTML = '<option value="all">Toutes les épreuves</option>';
        
        if (discipline !== 'all' && eventsByDiscipline[discipline]) {
            eventsByDiscipline[discipline].forEach(event => {
                const option = document.createElement('option');
                option.value = event;
                option.textContent = event;
                eventSelect.appendChild(option);
            });
        }
        
        update();
    });

    // Mise à jour quand une épreuve est sélectionnée
    document.getElementById('eventSelect').addEventListener('change', function() {
        state.event = this.value;
        update();
    });

    // Gestion de l'état de connexion
    function checkAuthState() {
        const user = JSON.parse(localStorage.getItem('user'));
        const userName = document.getElementById('userName');
        const logoutBtn = document.getElementById('logoutBtn');
        
        if (user) {
            userName.textContent = user.displayName || user.email;
            logoutBtn.style.display = 'block';
        } else {
            userName.textContent = 'Non connecté';
            logoutBtn.style.display = 'none';
        }
    }

    // Remplacer la vérification de connexion existante par celle-ci
document.addEventListener('DOMContentLoaded', () => {
    // Vérifier l'authentification Firebase au lieu du localStorage
    firebase.auth().onAuthStateChanged((user) => {
        if (!user && !window.location.href.includes('auth.html')) {
            // Rediriger vers auth.html seulement si on n'y est pas déjà
            window.location.replace('auth.html');
        }
    });
});

    // Gestionnaire de déconnexion
    document.getElementById('logoutBtn').addEventListener('click', async () => {
        try {
            await firebase.auth().signOut();
            localStorage.removeItem('user');
            window.location.replace('auth.html');
        } catch (error) {
            console.error('Erreur de déconnexion:', error);
        }
    });


    document.getElementById('userAvatar').addEventListener('click', () => {
    const logoutBtn = document.getElementById('logoutBtn');
    logoutBtn.style.display = logoutBtn.style.display === 'none' ? 'block' : 'none';
});

// Cacher le bouton de déconnexion quand on clique ailleurs
document.addEventListener('click', (e) => {
    if (!e.target.matches('#userAvatar')) {
        document.getElementById('logoutBtn').style.display = 'none';
    }
});

// Vérifier si l'utilisateur est connecté au chargement
document.addEventListener('DOMContentLoaded', () => {
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) {
        window.location.replace('auth.html');
    }
});
  </script>
</body>
</html>